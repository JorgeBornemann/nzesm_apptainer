BootStrap: docker
From: ubuntu:latest

%help
    Build a portable environment for the BICICLES code

%setup
    # create directory to build chombo and other packages in the container
    mkdir -p ${APPTAINER_ROOTFS}/usr/local/build

%files
    # copy files from host to the container prior to calling %post
    # SOURCE DESTINATION. SOURCE is always on the host. DESTINATION is by default in container
    # ADAPT!!!!!
    /home/pletzera/Chombo-3.2 /usr/local/build
    
%environment
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

%post

    apt-get update && apt-get upgrade -y

    echo "> Setting timezone to UTC non-interactively..."
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime
    apt-get install -y tzdata
    dpkg-reconfigure --frontend noninteractive tzdata

    apt-get install -y git vim perl csh python3 wget file subversion cmake cmake-curses-gui automake 
    apt-get install -y gcc gfortran g++ gcc
    apt-get install -y openmpi-bin openmpi-common
    apt-get install -y libnetcdf-pnetcdf-dev libhdf5-openmpi-dev
    apt-get install -y libfftw3-dev libmkl-full-dev

    # local copy of the code
    export BISICLES_HOME=$HOME/bisicles_trunk
    export BIKEFILES=$HOME/unicicles_files/
    export HDF5_LIBDIR=/usr/lib/x86_64-linux-gnu/hdf5/openmpi/
    export HDF5_INCDIR=/usr/include/hdf5/openmpi/

    export BUILD_DIR=/usr/local/build
    mkdir -p $BUILD_DIR

    # chombo
    cd $BUILD_DIR
    # svn co https://anag-repo.lbl.gov/svn/Chombo/release/3.2 Chombo #requires an anag repository account
    # the git repo is missing CoDimCopier.H
    #git clone https://github.com/applied-numerical-algorithms-group-lbnl/Chombo_3.2.git
    cd Chombo-3.2/lib
    wget https://raw.githubusercontent.com/pletzer/nzesm_apptainer/main/packages/chombo/gnu/Make.defs.local
    mv Make.defs.local mk/
    make all

    # # bisicles
    # cd $BUILD_DIR
    # git clone https://github.com/ggslc/bisicles-uob.git
    # cd bisicles-uob/exec2D
    # make clean
    # make

    # # build cdriver wrapper
    # cd $BUILD_DIR
    # cd bisicles-uob/code/cdriver
    # FC=gfortran make -f GNUmakefile.XXXX ftestwrapper

    # # build glimmer-cism
    # cd $BUILD_DIR
    # git clone https://github.com/ggslc/unicicles.git
    # cd unicicles/glimmer-cism
    # ./bootstrap
    # cd ..
    # mkdir parallel
    # cd parallel
    # FC=gfortran CXX=g++ FCFLAGS="-fno-range-check -ffree-line-length-0 -DBISICLES_CDRIVER -DNO_RESCALE  -fallow-argument-mismatch -fallow-invalid-boz -g -I$BISICLES_HOME/bisicles-uob/code/src " LDFLAGS=" -L$BISICLES_HOME/bisicles-uob/code/lib -lBisicles2d.Linux.64.CC.ftn.OPT.MPI -lChomboLibs2d.Linux.64.CC.ftn.OPT.MPI -L$PYTHONLIBS -lstdc++ -lcrypt -lpthread -ldl -lutil -lm -lpython3.9" ../glimmer-cism/configure --with-netcdf=$NETCDF_DIR --with-hdf5=$HDF5_DIR --enable-mpi --prefix=$PWD --disable-python
    # make
    # make install

    # # build unicicles wrapper from github
    # cd $BUILD_DIR/unicicles/wrappers/ukesm-ice_NETCDF
    # cp $BIKEFILES/Makefile.maui .
    # make clean -f Makefile.maui
    # make -f Makefile.maui
