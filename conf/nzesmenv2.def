BootStrap: docker
From: ubuntu:22.04

%setup
    #create directory structure to receive the libraries, tools, etc
    mkdir -p $APPTAINER_ROOTFS/opt
    mkdir -p $APPTAINER_ROOTFS/vagrant
    mkdir -p $APPTAINER_ROOTFS/home/vagrant
    mkdir -p $APPTAINER_ROOTFS/home/root


%post

    # set some environment variables
    export USER="root"
    dist="ubuntu"
    release="2204"

    # update the package info on the system
    apt-get -q -y update
    # upgrade the packages on the system
    apt-get -q -y upgrade

    apt-get -q -y install git
    apt-get -q -y install wget
    apt-get -q -y install dos2unix
    apt-get -q -y install vim

    # Install FCM dependencies & configuration
    apt-get install -q -y subversion 
    apt-get install -q -y libxml-parser-perl
    # #xdg-settings set default-web-browser chromium-browser.desktop
    apt-get install -q -y m4 
    apt-get install -q -y libconfig-inifiles-perl 
    apt-get install -q -y libdbi-perl 
    apt-get install -q -y g++ 
    apt-get install -q -y libsvn-perl
    apt-get install -q -y xxdiff
   
    # add the fcm script
    wget https://raw.githubusercontent.com/metomi/metomi-vms/master/usr/local/bin/fcm
    dos2unix -n ./fcm /usr/local/bin/fcm


    #### Install Cylc dependencies & configuration
    if [[ $dist == ubuntu ]]; then
    apt-get install -q -y at python-pip  || error
    service atd start || error
    if [[ $release != 2204 ]]; then
        apt-get install -q -y graphviz python-jinja2 python-pygraphviz python-gtk2 sqlite3 || error
    else
        apt-get install -q -y graphviz graphviz-dev python2-dev sqlite3 || error
        pip2 install jinja2 || error
        pip2 install "pyOpenSSL<19.1" || error
        pip2 install pygraphviz \
        --install-option="--include-path=/usr/include/graphviz" \
        --install-option="--library-path=/usr/lib/x86_64-linu-gnu" || error
        # Provide pygtk
        wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pycairo/python-cairo_1.16.2-2ubuntu2_amd64.deb
        wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pygobject-2/python-gobject-2_2.28.6-14ubuntu1_amd64.deb
        wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pygtk/python-gtk2_2.24.0-5.1ubuntu2_amd64.deb
        dpkg-deb -x python-gtk2_2.24.0-5.1ubuntu2_amd64.deb PackageFolder
        dpkg-deb --control python-gtk2_2.24.0-5.1ubuntu2_amd64.deb PackageFolder/DEBIAN
        sed -i 's/Depends: .*$/Depends: /' PackageFolder/DEBIAN/control
        dpkg -b PackageFolder python-gtk2_2.24.0-5.1ubuntu2_amd64-nodep.deb
        apt-get install -q -y ./python-gtk2_2.24.0-5.1ubuntu2_amd64-nodep.deb ./python-cairo_1.16.2-2ubuntu2_amd64.deb ./python-gobject-2_2.28.6-14ubuntu1_amd64.deb || error
        rm -rf PackageFolder *.deb
    fi
    apt-get install -q -y pep8 || error # used by test-battery
    if [[ $release != 1604 ]]; then
        : # Rose docs build no longer working - disable for the moment
        #apt-get install -q -y imagemagick || error
    fi
    elif [[ $dist == redhat ]]; then
    yum install -y graphviz at lsof || error
    service atd start || error
    # Ensure "hostname -f" returns the fully qualified name
    perl -pi -e 's/localhost localhost.localdomain/localhost.localdomain localhost/;' /etc/hosts
    fi

    # Add the Cylc wrapper scripts
    https://raw.githubusercontent.com/metomi/metomi-vms/master/usr/local/bin/cylc
    dos2unix -n ./cylc /usr/local/bin/cylc
    cd /usr/local/bin
    ln -sf cylc isodatetime
    ln -sf cylc gcylc

    cd 
    wget https://raw.githubusercontent.com/metomi/metomi-vms/master/opt/metomi-site/conf/global.rc
    # Configure additional copyable environment variables
    mkdir -p /opt/metomi-site/conf
    dos2unix -n ./global.rc /opt/metomi-site/conf/global.rc

    mkdir -p /opt/metomi-site/etc/cylc/flow/8
    wget https://raw.githubusercontent.com/metomi/metomi-vms/master/opt/metomi-site/etc/cylc/flow/8/global.cylc
    dos2unix -n ./global.cylc /opt/metomi-site/etc/cylc/flow/8/global.cylc

    # Insecure workaround for browser permissions error
    # See https://stackoverflow.com/questions/70753768/jupyter-notebook-access-to-the-file-was-denied
    mkdir -p /opt/metomi-site/etc/cylc/uiserver
    wget https://raw.githubusercontent.com/metomi/metomi-vms/master/opt/metomi-site/etc/cylc/uiserver/jupyter_config.py
    dos2unix -n ./jupyter_config.py /opt/metomi-site/etc/cylc/uiserver/jupyter_config.py

 







    # cylc
    if [[ $dist == ubuntu ]]; then
        apt-get install -q -y at python-pip || error
        service atd start || error
        apt-get install -q -y graphviz graphviz-dev python2-dev sqlite3 || error
        pip2 install jinja2 || error
        pip2 install "pyOpenSSL<19.1" || error
        pip2 install pygraphviz \
        --install-option="--include-path=/usr/include/graphviz" \
        --install-option="--library-path=/usr/lib/x86_64-linu-gnu" || error
        # Provide pygtk
        wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pycairo/python-cairo_1.16.2-2ubuntu2_amd64.deb
        wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pygobject-2/python-gobject-2_2.28.6-14ubuntu1_amd64.deb
        wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pygtk/python-gtk2_2.24.0-5.1ubuntu2_amd64.deb
        dpkg-deb -x python-gtk2_2.24.0-5.1ubuntu2_amd64.deb PackageFolder
        dpkg-deb --control python-gtk2_2.24.0-5.1ubuntu2_amd64.deb PackageFolder/DEBIAN
        sed -i 's/Depends: .*$/Depends: /' PackageFolder/DEBIAN/control
        dpkg -b PackageFolder python-gtk2_2.24.0-5.1ubuntu2_amd64-nodep.deb
        apt-get install -q -y ./python-gtk2_2.24.0-5.1ubuntu2_amd64-nodep.deb ./python-cairo_1.16.2-2ubuntu2_amd64.deb ./python-gobject-2_2.28.6-14ubuntu1_amd64.deb || error
        rm -rf PackageFolder *.deb
        apt-get install -q -y pep8 || error # used by test-battery
    if [[ $release != 1604 ]]; then
        : # Rose docs build no longer working - disable for the moment
        #apt-get install -q -y imagemagick || error
    fi

    # Add the Cylc wrapper scripts
    dos2unix -n /vagrant/usr/local/bin/cylc /usr/local/bin/cylc
    cd /usr/local/bin
    ln -sf cylc isodatetime
    ln -sf cylc gcylc
    # Configure additional copyable environment variables
    mkdir -p /opt/metomi-site/conf
    dos2unix -n /vagrant/opt/metomi-site/conf/global.rc /opt/metomi-site/conf/global.rc
    mkdir -p /opt/metomi-site/etc/cylc/flow/8
    dos2unix -n /vagrant/opt/metomi-site/etc/cylc/flow/8/global.cylc /opt/metomi-site/etc/cylc/flow/8/global.cylc
    # Insecure workaround for browser permissions error
    # See https://stackoverflow.com/questions/70753768/jupyter-notebook-access-to-the-file-was-denied
    mkdir -p /opt/metomi-site/etc/cylc/uiserver
    dos2unix -n /vagrant/opt/metomi-site/etc/cylc/uiserver/jupyter_config.py /opt/metomi-site/etc/cylc/uiserver/jupyter_config.py
















    #apt -y install curl
    #apt -y install file
    #apt -y install vim

    # prepare the installation
    # git clone https://github.com/metomi/metomi-vms.git
    # cd metomi-vms
    # cp -r * /vagrant
    # touch /home/vagrant/.bashrc
    # ls -ltr /vagrant
    

    # bash install.sh ubuntu 2204 mosrs 
    
        


