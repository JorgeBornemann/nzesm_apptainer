BootStrap: docker
From: ubuntu:22.04

%environment
    export PATH="HOME/bin:$PATH"


%setup
    # #create directory structure to receive the libraries, tools, etc
    # mkdir -p $APPTAINER_ROOTFS/opt
    # mkdir -p $APPTAINER_ROOTFS/vagrant
    # mkdir -p $APPTAINER_ROOTFS/home/vagrant
    # mkdir -p $APPTAINER_ROOTFS/home/root


%post

    # set some environment variables
    export USER="root"
    dist="ubuntu"
    release="2204"

    # update the package info on the system
    apt-get -q -y update
    # upgrade the packages on the system
    apt-get -q -y upgrade

    apt-get -q -y install git
    apt-get -q -y install wget
    apt-get -q -y install dos2unix
    apt-get -q -y install vim

    # Install FCM dependencies & configuration
    apt-get install -q -y subversion 
    apt-get install -q -y libxml-parser-perl
    # #xdg-settings set default-web-browser chromium-browser.desktop
    apt-get install -q -y m4 
    apt-get install -q -y libconfig-inifiles-perl 
    apt-get install -q -y libdbi-perl 
    apt-get install -q -y g++ 
    apt-get install -q -y libsvn-perl
    apt-get install -q -y xxdiff
   
    # base
    cd /
    git clone https://github.com/metomi/metomi-vms.git vagrant

    # Add the fcm wrapper script
    dos2unix -n /vagrant/usr/local/bin/fcm /usr/local/bin/fcm

    #### Install Cylc dependencies & configuration
    apt-get install -q -y at python-pip  || error
    service atd start || error
    apt-get install -q -y graphviz graphviz-dev python2-dev sqlite3 || error
    pip2 install jinja2 || error
    pip2 install "pyOpenSSL<19.1" || error
    pip2 install pygraphviz \
    --install-option="--include-path=/usr/include/graphviz" \
    --install-option="--library-path=/usr/lib/x86_64-linu-gnu" || error
    # Provide pygtk
    wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pycairo/python-cairo_1.16.2-2ubuntu2_amd64.deb
    wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pygobject-2/python-gobject-2_2.28.6-14ubuntu1_amd64.deb
    wget http://archive.ubuntu.com/ubuntu/pool/universe/p/pygtk/python-gtk2_2.24.0-5.1ubuntu2_amd64.deb
    dpkg-deb -x python-gtk2_2.24.0-5.1ubuntu2_amd64.deb PackageFolder
    dpkg-deb --control python-gtk2_2.24.0-5.1ubuntu2_amd64.deb PackageFolder/DEBIAN
    sed -i 's/Depends: .*$/Depends: /' PackageFolder/DEBIAN/control
    dpkg -b PackageFolder python-gtk2_2.24.0-5.1ubuntu2_amd64-nodep.deb
    apt-get install -q -y ./python-gtk2_2.24.0-5.1ubuntu2_amd64-nodep.deb ./python-cairo_1.16.2-2ubuntu2_amd64.deb ./python-gobject-2_2.28.6-14ubuntu1_amd64.deb || error
    rm -rf PackageFolder *.deb
    apt-get install -q -y pep8 || error # used by test-battery
    # Rose docs build no longer working - disable for the moment
    #apt-get install -q -y imagemagick || error

    # Add the Cylc wrapper scripts
    dos2unix -n /vagrant/usr/local/bin/cylc /usr/local/bin/cylc
    cd /usr/local/bin
    ln -sf cylc isodatetime
    ln -sf cylc gcylc
    # Configure additional copyable environment variables
    mkdir -p /opt/metomi-site/conf
    dos2unix -n /vagrant/opt/metomi-site/conf/global.rc /opt/metomi-site/conf/global.rc
    mkdir -p /opt/metomi-site/etc/cylc/flow/8
    dos2unix -n /vagrant/opt/metomi-site/etc/cylc/flow/8/global.cylc /opt/metomi-site/etc/cylc/flow/8/global.cylc
    # Insecure workaround for browser permissions error
    # See https://stackoverflow.com/questions/70753768/jupyter-notebook-access-to-the-file-was-denied
    mkdir -p /opt/metomi-site/etc/cylc/uiserver
    dos2unix -n /vagrant/opt/metomi-site/etc/cylc/uiserver/jupyter_config.py /opt/metomi-site/etc/cylc/uiserver/jupyter_config.py

    #### Install Rose dependencies & configuration
    apt-get install -q -y gfortran || error # gfortran is used in the brief tour suite
    apt-get install -q -y pcregrep || error
    apt-get install -q -y lxterminal || error # rose edit is configured to use this
    apt-get install -q -y tidy || error
    pip2 install requests || error
    pip2 install mock pytest-tap || error # used by test-battery

    # Add the Rose wrapper scripts
    cd /usr/local/bin
    ln -sf cylc rose
    ln -sf cylc rosie
    # Configure Rose
    mkdir -p /opt/metomi-site/etc
    dos2unix -n /vagrant/opt/metomi-site/etc/rose.conf /opt/metomi-site/etc/rose.conf
    mkdir -p /opt/metomi-site/etc/rose
    dos2unix -n /vagrant/opt/metomi-site/etc/rose/rose.conf /opt/metomi-site/etc/rose/rose.conf

    #### Install latest versions of FCM, Cylc & Rose
    # Ensure curl is installed
    apt-get install -q -y curl || error
    dos2unix -n /vagrant/usr/local/bin/install-fcm /usr/local/bin/install-fcm
    dos2unix -n /vagrant/usr/local/bin/install-cylc7 /usr/local/bin/install-cylc7
    dos2unix -n /vagrant/usr/local/bin/install-cylc8 /usr/local/bin/install-cylc8
    dos2unix -n /vagrant/usr/local/bin/install-rose /usr/local/bin/install-rose
    /usr/local/bin/install-fcm --set-default || error
    /usr/local/bin/install-cylc7 --set-default --make-docs || error
    /usr/local/bin/install-cylc8 || error
    /usr/local/bin/install-rose --set-default --make-docs || error
    # Set the default to Cylc 7
    ln -sf /opt/cylc-7 /opt/cylc

    # #### Configure cylc review & rosie web services (with a local rosie repository)
    # if [[ $dist == ubuntu ]]; then
    # if [[ $release != 2204 ]]; then
    #     apt-get install -q -y apache2 libapache2-mod-wsgi python-cherrypy3 apache2-utils python-sqlalchemy || error
    # else
    #     apt-get install -q -y apache2 apache2-dev apache2-utils || error
    #     pip2 install cherrypy sqlalchemy || error
    #     curl -L -s -S https://codeload.github.com/GrahamDumpleton/mod_wsgi/tar.gz/4.9.3 | tar -xz
    #     cd mod_wsgi-4.9.3
    #     ./configure --with-python=/usr/bin/python2
    #     make
    #     make install
    #     cd ..
    #     rm -r mod_wsgi-4.9.3
    #     echo "LoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi.so" > /etc/apache2/mods-enabled/wsgi.conf
    # fi
    # if [[ $release == 1604 ]]; then
    #     apt-get install -q -y libapache2-svn || error
    # else
    #     apt-get install -q -y libapache2-mod-svn || error
    # fi
    # elif [[ $dist == redhat ]]; then
    # if [[ $release == centos8 ]]; then
    #     yum install -y mod_dav_svn python2-sqlalchemy httpd-devel || error
    #     pip2 install mod_wsgi || error
    #     echo "LoadModule wsgi_module /usr/lib64/python2.7/site-packages/mod_wsgi/server/mod_wsgi-py27.so" > /etc/httpd/conf.modules.d/10-wsgi.conf
    # else
    #     yum install -y mod_dav_svn mod_wsgi python-cherrypy python-sqlalchemy || error
    # fi
    # fi
    # # Configure apache
    # mkdir -p /opt/metomi-site/etc/httpd
    # dos2unix -n /vagrant/opt/metomi-site/etc/httpd/rosie-wsgi.conf /opt/metomi-site/etc/httpd/rosie-wsgi.conf
    # if [[ $dist == ubuntu ]]; then
    # dos2unix -n /vagrant/opt/metomi-site/etc/httpd/svn.conf /opt/metomi-site/etc/httpd/svn.conf
    # elif [[ $dist == redhat ]]; then
    # dos2unix -n /vagrant/opt/metomi-site/etc/httpd/svn.conf.redhat /opt/metomi-site/etc/httpd/svn.conf
    # fi
    # ln -sf /opt /var/www/html
    # dos2unix -n /vagrant/var/www/html/index.html /var/www/html/index.html
    # if [[ $dist == ubuntu ]]; then
    # ln -sf /opt/metomi-site/etc/httpd/rosie-wsgi.conf /etc/apache2/conf-enabled/rosie-wsgi.conf
    # ln -sf /opt/metomi-site/etc/httpd/svn.conf /etc/apache2/conf-enabled/svn.conf
    # service apache2 restart || error
    # elif [[ $dist == redhat ]]; then
    # ln -sf /opt/metomi-site/etc/httpd/rosie-wsgi.conf /etc/httpd/conf.d/rosie-wsgi.conf
    # if [[ $release == centos7 ]]; then
    #     rm /etc/httpd/conf.d/subversion.conf
    # fi
    # ln -sf /opt/metomi-site/etc/httpd/svn.conf /etc/httpd/conf.d/subversion.conf
    # service httpd start || error
    # chkconfig --level 345 httpd on || error
    # fi

    # # cylc review needs to be able to access cylc-run directory
    # chmod 755 /home/vagrant
    # sudo -u $(logname) mkdir -p /home/vagrant/cylc-run
    # # Setup the rosie repository
    # mkdir /srv/svn
    # if [[ $dist == ubuntu ]]; then
    # sudo chown www-data /srv/svn
    # sudo -u www-data svnadmin create /srv/svn/roses-tmp
    # elif [[ $dist == redhat ]]; then
    # sudo chown apache /srv/svn
    # sudo -u apache svnadmin create /srv/svn/roses-tmp
    # fi
    # htpasswd -b -c /srv/svn/auth.htpasswd vagrant vagrant || error
    # # Cache the password
    # sudo -u $(logname) mkdir -p /home/vagrant/.subversion/auth/svn.simple
    # realm="<http://localhost:80> Subversion repository"
    # cache_id=$(echo -n "${realm}" | md5sum | cut -f1 -d " ")
    # sudo -u $(logname) bash -c "cat >/home/vagrant/.subversion/auth/svn.simple/${cache_id}" <<EOF
    # K 8
    # passtype
    # V 6
    # simple
    # K 8
    # password
    # V 7
    # vagrant
    # K 15
    # svn:realmstring
    # V ${#realm}
    # ${realm}
    # K 8
    # username
    # V 7
    # vagrant
    # END
    # EOF
    # cd /home/vagrant
    # sudo -H -u $(logname) bash -c 'svn co -q http://localhost/svn/roses-tmp'
    # sudo -H -u $(logname) bash -c 'svn ps fcm:layout -F - roses-tmp' <<EOF
    # depth-project = 5
    # depth-branch = 1
    # depth-tag = 1
    # dir-trunk = trunk
    # dir-branch =
    # dir-tag =
    # level-owner-branch =
    # level-owner-tag =
    # template-branch =
    # template-tag =
    # EOF
    # sudo -H -u $(logname) bash -c 'svn ci -m "fcm:layout: defined." roses-tmp'
    # rm -rf roses-tmp
    # mkdir -p /opt/metomi-site/etc/hooks
    # dos2unix -n /vagrant/opt/metomi-site/etc/hooks/pre-commit /opt/metomi-site/etc/hooks/pre-commit
    # ln -sf /opt/metomi-site/etc/hooks/pre-commit /srv/svn/roses-tmp/hooks/pre-commit
    # dos2unix -n /vagrant/opt/metomi-site/etc/hooks/post-commit /opt/metomi-site/etc/hooks/post-commit
    # ln -sf /opt/metomi-site/etc/hooks/post-commit /srv/svn/roses-tmp/hooks/post-commit
    # if [[ $dist == ubuntu ]]; then
    # sudo -u www-data /opt/rose/sbin/rosa db-create || error
    # elif [[ $dist == redhat ]]; then
    # sudo -u apache /opt/rose/sbin/rosa db-create || error
    # fi

    #### Miscellaneous utilities
    dos2unix -n /vagrant/usr/local/bin/install-iris /usr/local/bin/install-iris
    dos2unix -n /vagrant/usr/local/bin/install-jules-benchmark-data /usr/local/bin/install-jules-benchmark-data
    dos2unix -n /vagrant/usr/local/bin/install-jules-extras /usr/local/bin/install-jules-extras
    dos2unix -n /vagrant/usr/local/bin/install-jules-gswp2-data /usr/local/bin/install-jules-gswp2-data
    dos2unix -n /vagrant/usr/local/bin/install-master-versions /usr/local/bin/install-master-versions
    dos2unix -n /vagrant/usr/local/bin/install-nvidia /usr/local/bin/install-nvidia
    dos2unix -n /vagrant/usr/local/bin/install-ukca-data /usr/local/bin/install-ukca-data
    dos2unix -n /vagrant/usr/local/bin/install-um-data /usr/local/bin/install-um-data
    dos2unix -n /vagrant/usr/local/bin/install-um-extras /usr/local/bin/install-um-extras
    dos2unix -n /vagrant/usr/local/bin/run-test-batteries /usr/local/bin/run-test-batteries
    dos2unix -n /vagrant/usr/local/bin/um-setup /usr/local/bin/um-setup


 #### Install and configure gpg-agent
    apt-get install -q -y libgpg-error-dev libgcrypt20-dev libassuan-dev libksba-dev libpth-dev zlib1g-dev || error
      apt-get remove -q -y --auto-remove --purge gpg-agent || error
  curl -L -s -S https://www.gnupg.org/ftp/gcrypt/gnupg/gnupg-2.0.31.tar.bz2 | tar -xj || error
  cd gnupg-2.0.31
    ./configure CFLAGS="-fcommon" || error
  make || error
  make install || error
  cd ..
  rm -r gnupg-2.0.31
# Add script that caches the user's Science Repository Service password for the session
dos2unix -n /vagrant/usr/local/bin/mosrs-cache-password /usr/local/bin/mosrs-cache-password
# Add script to start gpg-agent and cache the password when needed and source it in .bashrc
dos2unix -n /vagrant/usr/local/bin/mosrs-setup-gpg-agent /usr/local/bin/mosrs-setup-gpg-agent
##echo ". /usr/local/bin/mosrs-setup-gpg-agent" >>/home/vagrant/.bashrc
# Add script to install Rose meta data
dos2unix -n /vagrant/usr/local/bin/install-rose-meta /usr/local/bin/install-rose-meta

#### Configure FCM
mkdir -p /etc/subversion
# Set up subversion to not use plaintext passwords for Met Office Science Repository Service
dos2unix -n /vagrant/etc/subversion/servers /etc/subversion/servers
# Set up subversion to use gpg-agent as the password store
dos2unix -n /vagrant/etc/subversion/config /etc/subversion/config
# Set up FCM keywords
mkdir -p /opt/metomi-site/etc/fcm
dos2unix -n /vagrant/opt/metomi-site/etc/fcm/keyword.cfg /opt/metomi-site/etc/fcm/keyword.cfg
ln -sf /opt/metomi-site/etc/fcm/keyword.cfg /opt/fcm/etc/fcm/keyword.cfg



# install UM dependencies
# for Ubuntu >= 18

    echo "Installing UM and mule dependencies..."
    apt-get install -y libnetcdf-dev libhdf5-dev netcdf-bin libnetcdff-dev libnetcdff7 libio-stringy-perl libipc-run-perl libperl-critic-perl

    echo
    echo "Configuring UM python settings..."
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1
    update-alternatives --install /usr/bin/python python /usr/bin/python2 2
    pip2 install numpy mock
    echo
    # echo "Adding mule to the installed python packages..."
    # echo "/home/${SUDO_USER}/umdir/mule/lib" > /usr/lib/python2.7/dist-packages/mule.pth
    
    echo
    echo "Installing UMDP dependencies..."
    apt-get install -y texlive texlive-latex-extra texlive-science

    echo
    echo "Installing eCcodes from source..."
    apt-get install -y libopenjp2-7-dev cmake
    mkdir -p /build
    cd /build
    curl -L -s -S https://confluence.ecmwf.int/download/attachments/45757960/eccodes-2.30.2-Source.tar.gz | tar -xz
    cd eccodes-2.30.2-Source
    mkdir -p build && cd build
    # can't put directly into /usr
    mkdir -p /usr/src/eccodes
    cmake -DCMAKE_INSTALL_PREFIX=/usr/src/eccodes -DENABLE_JPG=ON ../.
    make
    ctest
    make install
    # now copy necessary files into /usr
    cp /usr/src/eccodes/bin/* /usr/bin/.
    cp /usr/src/eccodes/lib/*.so /usr/lib/.
    cp /usr/src/eccodes/include/* /usr/include/.
    cd /build
    rm -rf eccodes-2.30.2-Source

    echo
    echo "Installing MPICH3 from source..."
    cd /build
    curl -L -s -S https://www.mpich.org/static/downloads/3.4.3/mpich-3.4.3.tar.gz | tar -xz
    cd mpich-3.4.3
    ./configure --build=x86_64-linux-gnu --prefix=/usr --includedir=\${prefix}/include --mandir=\${prefix}/share/man --infodir=\${prefix}/share/info --sysconfdir=/etc --localstatedir=/var --disable-option-checking --disable-silent-rules --libdir=\${prefix}/lib/x86_64-linux-gnu --disable-maintainer-mode --disable-dependency-tracking --with-libfabric=/usr --with-device=ch3 --with-pm=hydra --with-slurm=/usr --with-hwloc-prefix=/usr --with-wrapper-dl-type=none --enable-shared --without-yaksa --prefix=/usr --enable-fortran=all --disable-rpath --disable-wrapper-rpath --sysconfdir=/etc/mpich --libdir=/usr/lib/x86_64-linux-gnu --includedir=/usr/include/x86_64-linux-gnu/mpich --docdir=/usr/share/doc/mpich CPPFLAGS= CFLAGS= CXXFLAGS= "FFLAGS=-O2 -flto=auto -ffat-lto-objects -fstack-protector-strong  -fallow-invalid-boz -fallow-argument-mismatch" "FCFLAGS=-O2 -flto=auto -ffat-lto-objects -fstack-protector-strong  -fallow-invalid-boz -fallow-argument-mismatch" BASH_SHELL=/bin/bash | tee c.txt
    make 2>&1 | tee m.txt
    make install 2>&1 | tee mi.txt
    cd /build
    rm -rf mpich-3.4.3

    echo
    echo "Finished."



